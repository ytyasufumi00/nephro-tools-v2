import streamlit as st

# ==============================================================================
# 1. コンテンツデータ (変更なし)
# ==============================================================================
ICLS_DATA = {
    "⚡ 不整脈": [
        {
            "title": "脈ありＶＴの対応・同期/非同期",
            "text": """
            **【対応の原則】**
            * **不安定（意識障害、ショック、胸痛、心不全）:** 直ちに同期電気ショック。
            * **安定:** 薬剤投与を検討。

            **【同期 vs 非同期】**
            * **同期 (Synchronized):** QRS波の「R波」を感知し、受攻期（T波の頂点）を避けて放電する。脈がある頻拍（VT, AF, PSVT）で必須。
            * **非同期 (Asynchronized):** ボタンを押した瞬間に放電。VFや無脈性VT（R波がない、または認識できない場合）に使用。
            """
        },
        {
            "title": "r on Tの説明",
            "text": """
            **【解説】**
            * 心室の再分極過程（T波の頂点から終末にかけて）は、電気的に不安定な「受攻期（Vulnerable Period）」である。
            * このタイミングに外部刺激（R）が重なると、心室内で興奮の旋回が生じ、心室細動（VF）が誘発される現象。
            * これを防ぐために「同期」モードが存在する。
            """
        },
        {
            "title": "経皮ペーシング fixモードとr on T",
            "text": """
            **【モードの違い】**
            * **Demand:** 自己脈を感知（センス）して、無いときだけ打つ。基本はこちら。
            * **Fixed (Asynchronous):** 自己脈無視で一定のリズムで打つ。
            
            **【リスク】**
            * ノイズ等でDemandが作動しない場合にFixedにするが、自己脈が出た場合、ペーシング刺激がT波に重なり（R on T）、VFを誘発するリスクがある。
            """
        }
    ],
    "🔌 電気/AED": [
        {
            "title": "同期除細動の適応と推奨エネルギー",
            "text": """
            **【推奨エネルギー（二相性）】**
            * **心房細動 (AF):** **120〜200J**。閾値が高いため初回から強め。
            * **心房粗動 (AFL):** **50〜100J**。
            * **心室頻拍 (VT):** **100J**。
            * **発作性上室性頻拍 (PSVT):** **50〜100J**。
            """
        },
        {
            "title": "同期ショックのトラブル（放電しない？）",
            "text": """
            **【よくあるトラブル】**
            * 「ボタンを押したのに放電しない！」
            
            **【指導】**
            * 同期モードではR波を待つタイムラグがあるため、ボタンは**「長押し」**し続ける必要がある。
            """
        },
        {
            "title": "パドル10kg・クイックルック",
            "text": """
            **【パドル10kg】**
            * インピーダンス（電気抵抗）を下げ、心臓への通電効率を上げるため。
            
            **【クイックルックのデメリット】**
            * アーチファクトが入りやすく、結局パッドを貼る方がハンズオフ時間が短縮できるため、現在はパッドファーストが推奨。
            """
        },
        {
            "title": "AEDと無脈性VTのジレンマ",
            "text": """
            **【解説】**
            * AEDは「波形が整っているVT」に対して「脈があるかも？」と判断し、**ショック不要**と出ることがある。
            * 医療者は臨床所見（脈なし）を優先し、マニュアル除細動器でショックを行う必要がある。
            """
        },
        {
            "title": "AEDの詳細（トリビア・指導法）",
            "text": """
            **【ポイント】**
            * **インピーダンス測定:** 体格や乾燥具合で出力を調整している。
            * **離れる理由:** 感電防止に加え、振動によるノイズ（VF誤認）を防ぐため。
            * **右前・左側:** 心臓を電流のベクトルで挟むため。「前後」も有効。
            * **ペースメーカー:** 現代のAEDはフィルタが優秀なので、スパイクがあってもVFを検知できる。迷わず貼る。
            """
        },
        {
            "title": "2重連続除細動 (DSD)",
            "text": """
            **【Double Sequential Defibrillation】**
            * 難治性VFに対し、2台の除細動器で「前側」「前後」にパッドを貼り、連続ショックを行う手法。
            """
        }
    ],
    "❤️ BLS": [
        {
            "title": "BLSの孤立シチュエーション",
            "text": """
            **【対応】**
            * スマホのスピーカーフォン活用（通信指令員のPA）。
            * 通行人を具体的に指名して役割を振る。
            """
        },
        {
            "title": "衣類の除去・役割交代",
            "text": """
            **【衣類】**
            * 躊躇なく切る。ワイヤー入りブラジャーは外すか切る（分流・火傷防止）。
            
            **【交代】**
            * 疲労は2分でピーク。Pre-emptive orderで予告し、5秒以内でスライド交代する。
            """
        },
        {
            "title": "CCFとMICR",
            "text": """
            **【CCF (Chest Compression Fraction)】**
            * 圧迫している時間の割合。60%以上（目標80%）で生存率向上。
            
            **【MICR】**
            * アリゾナ・プロトコル。初期は人工呼吸を省略し、圧迫継続を最優先する手法。
            """
        }
    ],
    "🤝 チーム": [
        {
            "title": "フォロワーシップの3要素",
            "text": """
            1.  **Shared Mental Model:** 状況の共有。
            2.  **Speak Up:** 懸念の表明。
            3.  **Constructive Intervention:** 建設的介入。
            """
        },
        {
            "title": "過剰な配慮とハイジャック",
            "text": """
            **【過剰な配慮】**
            * 忖度は医療安全の敵。「命を守る指摘は失礼ではない」と教える。
            
            **【ハイジャック】**
            * メンバーが勝手に指示を出すのはNG。
            * リーダーが機能不全なら「交代します」と宣言して引き継ぐ。
            """
        }
    ],
    "🎓 教育": [
        {
            "title": "BLS相互評価・シークレットインストラクション",
            "text": """
            **【相互評価】**
            * 受講生同士で「深さは？」「戻りは？」と指摘し合わせる。
            
            **【シークレットインストラクション】**
            * 特定の受講生に「わざと過換気して」「小声で話して」と指示し、リーダーが気づけるか試す手法。
            """
        }
    ],
    "💊 薬剤": [
        {
            "title": "不整脈用薬剤の詳細",
            "text": """
            * **アミオダロン:** 初回150mg 10分静注。維持投与あり。
            * **ニフェカラント:** 0.3mg/kg 静注。
            * **リドカイン:** 1〜1.5mg/kg 静注（虚血性心疾患疑い）。
            """
        },
        {
            "title": "ドパミン vs ノルアドレナリン",
            "text": """
            **【ノルアド優位】**
            * ドパミンは不整脈誘発リスクが高い。
            * 心原性ショック等では、ノルアドレナリンの方が死亡率が低い（または同等）ため第一選択。
            """
        }
    ],
    "💧 輸液": [
        {
            "title": "輸液・ルート確保",
            "text": """
            **【ルート確保】**
            * 心停止時は**上肢（肘正中など）**が推奨。
            * 骨髄路（IO）も早期に検討。
            * 輸液剤は細胞外液（リンゲル液、生理食塩水）。
            """
        }
    ],
    "🫁 呼吸": [
        {
            "title": "500-600ml指導と5-6ml/kg",
            "text": """
            **【指導】**
            * 生理学的理想(6-8ml/kg)に対し、BVMは容量が大きいため、「半分」では多すぎる。
            * 「指先でクシュッと」「1/3握る」程度で十分。
            """
        },
        {
            "title": "換気回数とCCF",
            "text": """
            **【回数】**
            * 成人挿管後: 10回/分（6秒に1回）。
            
            **【CCFとの関係】**
            * 30:2の同期換気で4秒以上かけるとCCFが低下する。「1秒入れ、1秒出す」×2回＝4秒以内厳守。
            """
        },
        {
            "title": "過換気の害",
            "text": """
            **【メカニズム】**
            * 胸腔内圧上昇 → 静脈還流阻害。
            * 低CO2 → 脳血管収縮。
            """
        }
    ],
    "🧪 挿管/気道": [
        {
            "title": "挿管後の確認・管理",
            "text": """
            **【確認】**
            * 聴診（5点）よりも**波形カプノグラフィ**がGold Standard。
            * エコーも有効。
            
            **【設定】**
            * トリガーはOFF（圧迫を自発呼吸と誤認させないため）。
            """
        },
        {
            "title": "ルーカス中の換気・BVMのコツ",
            "text": """
            **【コツ】**
            * ルーカスは圧迫時間が長い。圧解除の一瞬を狙う。
            * 非同期換気。
            """
        },
        {
            "title": "気道異物・igel",
            "text": """
            **【異物】**
            * マギル鉗子は「見えているもの」だけ。盲目的操作は禁忌。
            
            **【igel】**
            * カフなし、操作簡単。
            * 舌の循環障害リスクのため、使用は4時間以内を目安に。
            """
        }
    ],
    "🏥 蘇生後": [
        {
            "title": "TTM・シバリング・てんかん",
            "text": """
            **【TTM】**
            * 33-36℃、または「発熱回避（37.5℃以下）」。
            
            **【シバリング】**
            * 35-36℃で好発。皮膚加温、鎮静剤、筋弛緩剤で対応。
            
            **【てんかん】**
            * 蘇生後脳症に合併しやすい。予防投与も考慮。ミオクローヌスとの鑑別。
            """
        },
        {
            "title": "CO2管理・4H4T",
            "text": """
            **【CO2管理】**
            * PaCO2 35-45mmHg（正常値）を目指す。低CO2は脳虚血のリスク。
            
            **【4H4T】**
            * PEA/Asystoleの原因検索。
            * Hypoxia, Hypovolemia, Hyper/Hypokalemia, Hypothermia
            * Tension pneumothorax, Tamponade, Toxins, Thrombosis
            """
        },
        {
            "title": "冠動脈疾患疑い対応",
            "text": """
            * 12誘導ST上昇確認。
            * 左上肢ルート確保（右はカテ用）。
            * 抗血小板薬、ヘパリン準備。
            """
        }
    ],
    "🫀 移植": [
        {
            "title": "臓器提供の要点",
            "text": """
            **【対応】**
            * 脳死・心停止後臓器提供の可能性があればNWへ連絡。
            * 家族説明の前にコーディネーターへ相談（虐待除外など）。
            
            **【種類】**
            * 脳死下（心・肺・肝・腎など）、心停止後（腎・眼球）。
            """
        }
    ],
    "👶 その他": [
        {
            "title": "妊産婦・小児",
            "text": """
            **【妊産婦】**
            * 用手子宮左方圧排。死戦期帝王切開（PMCD）。
            
            **【小児】**
            * 呼吸原性が9割。15:2推奨。
            * HR<60かつ循環不全サインで圧迫開始。
            * 挿管後の換気は20-30回/分（代謝高い）。
            """
        }
    ],
    "📘 GL": [
        {
            "title": "JRC2025・地域GL",
            "text": """
            **【JRC2025予想】**
            * 換気回数増加？（成人10回→?）
            * DSDの推奨度。
            * 回復体位の脊椎固定解除。
            
            **【議論】**
            * 回数を増やすなら一回換気量は減らすべき（肺保護）。
            """
        }
    ]
}

# ==============================================================================
# 2. アプリケーション設定・レスポンシブグリッド構築
# ==============================================================================
def main():
    st.set_page_config(
        page_title="ICLS Guide",
        page_icon="🚑",
        layout="wide"
    )

    # セッション状態の初期化
    if 'selected_category' not in st.session_state:
        st.session_state.selected_category = list(ICLS_DATA.keys())[0]

    # ------------------------------------------------------------------
    # CSSによるレスポンシブデザイン（ここが重要）
    # ------------------------------------------------------------------
    # 解説:
    # 1. flex-wrap: wrap ... カラムを折り返し可能にする
    # 2. @media (max-width: 640px) ... スマホ幅のとき
    # 3. width: 33.33% ... 3列にする
    # 4. @media (min-width: 641px) ... PC幅のとき
    # 5. width: 25% ... 4列にする
    # ------------------------------------------------------------------
    st.markdown("""
        <style>
            /* 全体の余白調整 */
            .block-container {
                padding-top: 1rem;
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
            
            /* カラムの親コンテナ（水平ブロック）を折り返し可能にする */
            [data-testid="stHorizontalBlock"] {
                flex-wrap: wrap !important;
                gap: 0.3rem !important; /* ボタン間の隙間 */
            }
            
            /* 各カラム（ボタンの入れ物）の幅制御 */
            [data-testid="column"] {
                flex: 1 1 auto !important;
                min-width: 0 !important;
                margin-bottom: 0px !important;
            }

            /* --- スマホ画面 (幅640px以下) --- */
            @media (max-width: 640px) {
                [data-testid="column"] {
                    /* 3列表示（約33%） */
                    width: 32% !important;
                    max-width: 32% !important;
                    flex: 0 0 32% !important;
                }
                /* ボタンの文字サイズ極小化 */
                div.stButton > button {
                    font-size: 10px !important;
                    padding: 0px 2px !important;
                    height: 45px !important;
                    white-space: normal !important; /* 文字の折り返し許可 */
                    line-height: 1.1 !important;
                }
            }

            /* --- PC/タブレット画面 (幅641px以上) --- */
            @media (min-width: 641px) {
                [data-testid="column"] {
                    /* 4列表示（25%） */
                    width: 24% !important;
                    max-width: 24% !important;
                    flex: 0 0 24% !important;
                }
                 div.stButton > button {
                    font-size: 14px !important;
                    height: 50px !important;
                }
            }
            
            /* ボタン共通スタイル */
            div.stButton > button {
                width: 100%;
                border-radius: 8px;
                border: 1px solid #ccc;
            }
        </style>
    """, unsafe_allow_html=True)

    st.title("🚑 ICLS Instructor Guide")

    # ---------------------------------------------------------
    # カテゴリボタンの生成（レスポンシブ）
    # ---------------------------------------------------------
    categories = list(ICLS_DATA.keys())
    
    # Python側では「全カテゴリ数分のカラム」を1行で作成する
    # CSSでこれを折り返すように制御している
    cols = st.columns(len(categories))

    for i, cat_name in enumerate(categories):
        with cols[i]:
            # 現在選択されているカテゴリなら色を変える
            btn_type = "primary" if st.session_state.selected_category == cat_name else "secondary"
            
            # キーを指定してボタンの重複エラーを防ぐ
            if st.button(cat_name, key=f"btn_{i}", type=btn_type, use_container_width=True):
                st.session_state.selected_category = cat_name
                st.rerun()

    st.markdown("---")

    # ---------------------------------------------------------
    # 選択されたカテゴリの内容を描画
    # ---------------------------------------------------------
    current_cat = st.session_state.selected_category
    
    # スマホで見やすいようにヘッダーの文字サイズも少し調整
    st.markdown(f"##### {current_cat}")
    
    if current_cat in ICLS_DATA:
        items = ICLS_DATA[current_cat]
        for item in items:
            with st.expander(f"📌 {item['title']}", expanded=False):
                st.markdown(item['text'])

if __name__ == "__main__":
    main()
