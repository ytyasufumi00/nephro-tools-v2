import streamlit as st

# ------------------------------------------------------------------
# 1. コンテンツデータ (全トピック網羅版)
# ------------------------------------------------------------------
ICLS_CONTENT = {
    "⚡ 不整脈・除細動": [
        {
            "title": "脈ありVTの対応と薬剤",
            "points": [
                "原則: 安定していれば薬剤、不安定（ショック・胸痛・心不全・意識障害）なら同期電気ショック。",
                "アミオダロン: 150mg/10分かけて静注。維持投与へ。",
                "ニフェカラント: 0.3mg/kg。",
                "リドカイン: 1〜1.5mg/kg (虚血性心疾患に有効)。"
            ],
            "columns": [
                {
                    "head": "同期 vs 非同期の考え方と「R on T」",
                    "text": """
                    **R on T現象とは:**
                    心室の再分極期（T波の頂点付近）は電気的に不安定な時期（受攻期）です。ここに刺激が加わると、VF（心室細動）を誘発します。
                    
                    * **同期 (Synchronized):** QRS波の「R波」を機械が認識し、T波を避けて放電します。脈がある頻拍（VT, AF, PSVT）で使用します。
                    * **非同期 (Asynchronized):** ボタンを押した瞬間に放電します。VFや無脈性VTには「R波がない」ため、非同期しか使えません（そもそもVFになっているのでR on Tを気にする必要がない）。
                    """
                },
                {
                    "head": "推奨エネルギーと設定",
                    "text": """
                    * **AF (心房細動):** 初回 120-200J (二相性)。心房は図体がデカいので強めで。
                    * **AFL (心房粗動):** 初回 50-100J。非常に切れやすい。
                    * **PSVT / VT:** 初回 100J程度。
                    
                    **トラブル演出の指導:**
                    同期ボタンを押したのに放電しない！ → **「同期モードではR波を待つため、ボタンを長押しし続ける必要がある」**ことを体験させるシナリオが有効です。
                    """
                }
            ]
        },
        {
            "title": "除細動器のトリビア・禁忌",
            "points": [
                "パドル10kgの意味: インピーダンス（電気抵抗）を下げるため。体重を乗せる。",
                "クイックルック: パドルで波形を見る手法。デメリットは「接触不良によるアーチファクト混入」と「ハンズオフ時間の延長」。現在はパッド装着推奨。",
                "単相性（Monophasic）: 360Jドカンと流す旧式。心筋ダメージが大きいため、倉庫にあっても使ってはいけない。"
            ],
            "columns": [
                {
                    "head": "AEDと無脈性VTのジレンマ",
                    "text": """
                    AEDは「VF」には強く反応しますが、「きれいな形のVT」に対しては、「これ、脈あるんじゃない？」と機械が迷い、ショック不要と判断することが稀にあります。
                    この場合、**「反応がない（CPA）」なら、AEDの指示に従わず（機種によっては従わざるを得ませんが）、医療者が判断できるならマニュアル除細動器へ移行**する必要があります。
                    """
                },
                {
                    "head": "2重連続除細動 (Dual Sequential Defibrillation)",
                    "text": """
                    難治性VF（Electric Storm）に対し、**2台の除細動器**を用いて、パッドを「前後」と「左右」に貼り、ほぼ同時に（または連続して）ショックを行う荒技。
                    心筋の不応期を広範囲にリセットする理論ですが、機器の故障リスクもあり、ガイドラインでの推奨度はまだ議論中（JRC2025の注目点）。
                    """
                }
            ]
        },
        {
            "title": "デバイス植込み患者・ペーシング",
            "points": [
                "ICD/ペースメーカー: 本体から「指2-3本分」離してパッドを貼る。",
                "経皮ペーシング: Demandモードが基本だが、ノイズで抑制されるならFixedモード。ただしFixedはR on Tのリスクがあるため、捕捉されたらDemandに戻す。"
            ]
        }
    ],
    "❤️ BLS・チーム": [
        {
            "title": "チームダイナミクス・指導法",
            "points": [
                "相互評価: 受講生同士で「今の深さはどうだった？」とフィードバックさせる。",
                "シークレットインストラクション: 特定の受講生に「わざと過換気して」「小声で話して」と密命を与え、リーダーが気づけるか試す。",
                "フォロワーシップ: ただ従うだけでなく、「Shared Mental Model（状況認識の共有）」と「Speak up（懸念の表出）」を行う。"
            ],
            "columns": [
                {
                    "head": "「過剰な配慮」への警鐘とハイジャック",
                    "text": """
                    * **過剰な配慮:** 日本人に多い。「リーダーが忙しそうだから黙っておこう」はチームを殺す。間違いに気づいたら「Constructive Intervention（建設的介入）」が必要。
                    * **ハイジャック:** 知識のあるメンバーが、リーダーを無視して勝手に仕切り出すこと。これは混乱を招く。
                    * **リーダー交代:** リーダーがパニック（フリーズ）したり、手技（挿管など）に没頭する場合は、速やかに「リーダー交代します」と宣言して役割を引き継ぐ重要性を説く。
                    """
                }
            ]
        },
        {
            "title": "BLSの実践テクニック",
            "points": [
                "孤立シチュエーション: スマホのスピーカー活用、通りがかりの人への具体的指示（「あなたは救急車！」）。",
                "衣類除去: 躊躇しない。ハサミがなければ引きちぎるか、首元からまくり上げる。ブラジャーの金具は避ける。",
                "役割交代: 気道管理者（頭側）が司令塔になりやすい。疲労が見える前に「次の2分で交代」と予告（Pre-emptive order）。",
                "新人との交代: 「私の掛け声に合わせて入って」と並走し、リズムを同期させてからスライドする。"
            ],
            "columns": [
                {
                    "head": "胸骨圧迫比率 (CCF) とアリゾナMICR",
                    "text": """
                    * **CCF:** 心停止時間のうち、圧迫している時間の割合。**60%以上（目標80%）**が生存率と相関する。換気時間、パルスチェック時間を削るのが鍵。
                    * **アリゾナMICR (Minimally Interrupted Cardiac Resuscitation):**
                        「換気よりも圧迫」を極端に推し進めたプロトコル。
                        初期数分間は**「人工呼吸をせず、酸素投与下でひたすら圧迫し続ける」**手法。目撃ありVFなどで良好な成績を出した（マイカーとも呼ばれる）。
                    """
                }
            ]
        }
    ],
    "🫁 呼吸・気道": [
        {
            "title": "換気量と回数のロジック",
            "points": [
                "一回換気量: 理想は **6-8ml/kg** だが、現場では計算できない。",
                "指導: 成人用BVM（1000ml以上）を半分握ると多すぎる。**「500-600ml（胸が上がる程度）」**と教えるのが実践的。",
                "換気回数: 挿管後 **10回/分 (6秒に1回)**。過換気を防ぐためのミニマム設定。"
            ],
            "columns": [
                {
                    "head": "なぜ過換気は予後を悪化させるのか？",
                    "text": """
                    1.  **胸腔内圧上昇:** 静脈還流（心臓への戻り）が阻害され、心拍出量が低下する。CPRの効果がなくなる。
                    2.  **脳血管収縮:** 低CO2血症（PaCO2低下）は脳血管を収縮させ、脳血流を低下させる。
                    
                    **JRC2025/最近の議論:**
                    「一回換気量はもっと少なくて良いのでは？」「回数はもっと多くても良いのでは（特に小児や代謝亢進時）？」という議論が進んでいる。
                    """
                }
            ]
        },
        {
            "title": "気道管理の実践",
            "points": [
                "i-gel: メリットは「誰でも入る」。デメリットは「4時間の時間制限（巨舌）」と「確実な誤嚥防止ではない」。",
                "マギル鉗子: 異物が見えている時のみ。奥に押し込まないよう、喉頭鏡で展開しながら「つまみ出す」。",
                "挿管後の確認: 最近は**5点聴診**よりも、**波形カプノグラフィ**と**超音波（エコー）**が推奨レベルが高い。"
            ],
            "columns": [
                {
                    "head": "LUCAS装着時の換気・人工呼吸器設定",
                    "text": """
                    * **LUCASと換気:** 機械的圧迫は強力で、胸郭が押しつぶされる時間が長い。換気できる「隙間」が短いので、一瞬で吸わせる必要があるが、高圧アラームが鳴りやすい。
                    * **人工呼吸器設定:**
                        * モード: VCV (従量式) が無難。
                        * トリガー: オフにする（体動・圧迫振動を自発呼吸と誤認して勝手に吸わせるのを防ぐ）。
                        * アラーム: 気道内圧上限を高めに設定する。
                    """
                }
            ]
        }
    ],
    "🏥 ROSC後・管理": [
        {
            "title": "体温管理療法 (TTM) とシバリング",
            "points": [
                "目標: 33-36℃。最近は36℃（発熱回避）が主流になりつつある。",
                "シバリング: 冷却の敵。酸素消費を激増させる。",
                "対策: 保温（皮膚）、マグネシウム、鎮静剤（プロポフォール）、筋弛緩剤。",
                "鑑別: シバリングかてんかん（ミオクローヌス）か？ 脳波がないと難しいが、リズミカルか、刺激で誘発されるかで判断。"
            ],
            "columns": [
                {
                    "head": "CO2管理と脳血流",
                    "text": """
                    ROSC後のCO2は**「正常〜軽度高め (35-45 mmHg)」**を目指します。
                    * 低CO2 → 脳血管収縮 → 虚血
                    * 高CO2 → 脳血管拡張 → 頭蓋内圧亢進
                    
                    モニターのEtCO2と、血液ガス（PaCO2）の乖離（死腔）に注意してください。
                    """
                }
            ]
        },
        {
            "title": "薬剤と臓器提供",
            "points": [
                "昇圧剤: **ドパミンよりノルアドレナリン**。ドパミンは不整脈誘発リスクが高いため、現在は第一選択ではない。",
                "臓器提供: 「脳死判定ができる施設（類型）」への転院が必要な歴史があったが、現在は法的整備が進んでいる。",
                "連絡先: **日本臓器移植ネットワーク**。迷ったらコーディネーターに相談（虐待除外などのコツも教えてくれる）。",
                "蘇生後の移植: 脳死下だけでなく、心停止後腎移植（マージナルドナー）なども行われている。"
            ]
        }
    ],
    "👶 特殊・JRC2025": [
        {
            "title": "小児・妊産婦のポイント",
            "points": [
                "小児HR<60: 循環不全サインがあれば**「胸骨圧迫」**対象。脈があっても瀕死。",
                "小児換気: 成人と違い**「呼吸原性」**が主因。15:2を推奨。換気回数は20-30回/分と多め。",
                "妊産婦: **用手子宮左方圧排**。母体蘇生が最優先。",
                "冠動脈疾患疑い: 循環器医待ちの間に、ルート（左手）、A-Pパッド、ヘパリン準備。"
            ]
        },
        {
            "title": "JRC2025 / 長野県ガイドライン予想",
            "points": [
                "換気回数: 成人も「10回」から増える可能性（小児に続き）。",
                "一回換気量: より少ない量での換気推奨？",
                "4H4Tの覚え方: Hypoxia, Hypovolemia... (語呂: 酸素・水・熱・カリ / 肺・栓・毒・タンポ)",
                "長野県独自: 搬送基準や特定行為のプロトコル変更（地域事情に即した拡大）の可能性。"
            ]
        }
    ]
}

# ------------------------------------------------------------------
# 2. アプリケーション設定・メイン処理
# ------------------------------------------------------------------
def main():
    st.set_page_config(page_title="ICLS Instructor Master Guide", page_icon="🚑", layout="centered")

    # CSSで見た目を調整（スマホ対応・見やすさ重視）
    st.markdown("""
        <style>
            /* 全体の余白調整 */
            .block-container {
                padding-top: 1rem !important;
                padding-bottom: 3rem !important;
            }
            /* タブのデザイン */
            .stTabs [data-baseweb="tab-list"] {
                gap: 5px;
                flex-wrap: wrap;
            }
            .stTabs [data-baseweb="tab"] {
                height: auto;
                background-color: #f8f9fa;
                border-radius: 5px 5px 0 0;
                padding: 0.5rem 0.8rem;
                font-weight: 600;
                font-size: 0.85rem;
            }
            .stTabs [aria-selected="true"] {
                background-color: #e3f2fd;
                border-bottom: 3px solid #1565c0;
                color: #1565c0;
            }
            /* Expander（通常） */
            .streamlit-expanderHeader {
                font-weight: 700;
                font-size: 1rem;
                background-color: #ffffff;
                border-left: 5px solid #1565c0;
                border-radius: 0 5px 5px 0;
                margin-top: 5px;
            }
            /* コラム用Expander */
            div[data-testid="stExpander"] div[data-testid="stExpander"] .streamlit-expanderHeader {
                font-size: 0.95rem;
                color: #2e7d32; 
                border-left: 5px solid #2e7d32;
                background-color: #e8f5e9;
            }
            /* リストなどの文字サイズ */
            li {
                margin-bottom: 5px;
                line-height: 1.5;
            }
        </style>
    """, unsafe_allow_html=True)

    st.title("ICLS Instructor Master Guide 🚑")
    st.caption("現場の「実践知」と「指導のネタ」を網羅した完全版リファレンス")

    # タブ生成
    tabs = st.tabs(list(ICLS_CONTENT.keys()))

    for i, category in enumerate(ICLS_CONTENT.keys()):
        with tabs[i]:
            for item in ICLS_CONTENT[category]:
                # メインのトピック（要点）
                with st.expander(f"📌 {item['title']}", expanded=False):
                    
                    # 1. 要点（Points）の表示
                    st.markdown("#### ✅ Key Points")
                    for point in item['points']:
                        # 特定のキーワードを太字にする簡易処理
                        fmt_point = point.replace("推奨", "**推奨**").replace("禁忌", "**禁忌**")
                        st.markdown(f"- {fmt_point}")
                    
                    # 2. 詳細コラム（Columns）がある場合のみ表示
                    if "columns" in item:
                        st.markdown("---")
                        st.markdown("#### 📖 Deep Dive & Instruction Tips")
                        
                        for col in item['columns']:
                            # コラムをサブExpanderとして表示
                            with st.expander(f"🤔 {col['head']}"):
                                st.info(col['text'])

if __name__ == "__main__":
    main()
