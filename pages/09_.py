import streamlit as st

# ==============================================================================
# 1. コンテンツデータ (重要度順に並び替え済み)
# ==============================================================================
ICLS_DATA = {
    "❤️ BLS": [
        {
            "title": "BLSの孤立シチュエーション",
            "text": """
            **【対応】**
            * スマホのスピーカーフォン活用（通信指令員のPA）。
            * 通行人を具体的に指名して役割を振る。
            """
        },
        {
            "title": "衣類の除去・役割交代",
            "text": """
            **【衣類】**
            * 躊躇なく切る。ワイヤー入りブラジャーは外すか切る（分流・火傷防止）。
            
            **【交代】**
            * 疲労は2分でピーク。Pre-emptive orderで予告し、5秒以内でスライド交代する。
            """
        },
        {
            "title": "CCFとMICR",
            "text": """
            **【CCF (Chest Compression Fraction)】**
            * 圧迫している時間の割合。60%以上（目標80%）で生存率向上。
            
            **【MICR】**
            * アリゾナ・プロトコル。初期は人工呼吸を省略し、圧迫継続を最優先する手法。
            """
        }
    ],
    "⚡ 不整脈": [
        {
            "title": "脈ありＶＴの対応・同期/非同期",
            "text": """
            **【対応の原則】**
            * **不安定（意識障害、ショック、胸痛、心不全）:** 直ちに同期電気ショック。
            * **安定:** 薬剤投与を検討。

            **【同期 vs 非同期】**
            * **同期 (Synchronized):** QRS波の「R波」を感知し、受攻期（T波の頂点）を避けて放電する。脈がある頻拍（VT, AF, PSVT）で必須。
            * **非同期 (Asynchronized):** ボタンを押した瞬間に放電。VFや無脈性VT（R波がない、または認識できない場合）に使用。
            """
        },
        {
            "title": "r on Tの説明",
            "text": """
            **【解説】**
            * 心室の再分極過程（T波の頂点から終末にかけて）は、電気的に不安定な「受攻期（Vulnerable Period）」である。
            * このタイミングに外部刺激（R）が重なると、心室内で興奮の旋回が生じ、心室細動（VF）が誘発される現象。
            * これを防ぐために「同期」モードが存在する。
            """
        },
        {
            "title": "経皮ペーシング fixモードとr on T",
            "text": """
            **【モードの違い】**
            * **Demand:** 自己脈を感知（センス）して、無いときだけ打つ。基本はこちら。
            * **Fixed (Asynchronous):** 自己脈無視で一定のリズムで打つ。
            
            **【リスク】**
            * ノイズ等でDemandが作動しない場合にFixedにするが、自己脈が出た場合、ペーシング刺激がT波に重なり（R on T）、VFを誘発するリスクがある。
            """
        }
    ],
    "🔌 電気/AED": [
        {
            "title": "同期除細動の適応と推奨エネルギー",
            "text": """
            **【推奨エネルギー（二相性）】**
            * **心房細動 (AF):** **120〜200J**。閾値が高いため初回から強め。
            * **心房粗動 (AFL):** **50〜100J**。
            * **心室頻拍 (VT):** **100J**。
            * **発作性上室性頻拍 (PSVT):** **50〜100J**。
            """
        },
        {
            "title": "同期ショックのトラブル（放電しない？）",
            "text": """
            **【よくあるトラブル】**
            * 「ボタンを押したのに放電しない！」
            
            **【指導】**
            * 同期モードではR波を待つタイムラグがあるため、ボタンは**「長押し」**し続ける必要がある。
            """
        },
        {
            "title": "パドルのメリット、デメリット・クイックルック",
            "text": """
            **【パドルのデメリット】**
            * 10kgと圧着にかなり力を要する！
            * パドル in Airの恐怖！　拳銃を人に向けている様なもの。
            * そのジェルは間違いなく通電用？　ジェルはパドルではなく体に塗っておく、が、見えない、滑る、胸骨圧迫で困る、、ジェルパッドを推奨。
            * パドルはこすり合わせないで！　傷つくと抵抗が上昇し除細動失敗や熱傷のもとになる
            
            **【クイックルックのメリット、デメリット】**
            * 
            """
        },
        {
            "title": "AEDと無脈性VTのジレンマ",
            "text": """
            **【解説】**
            * AEDは「波形が整っているVT」に対して「脈があるかも？」と判断し、**ショック不要**と出ることがある。
            * 医療者は臨床所見（脈なし）を優先し、マニュアル除細動器でショックを行う必要がある。
            """
        },
        {
            "title": "AEDの詳細（トリビア・指導法）",
            "text": """
            **【ポイント】**
            * **インピーダンス測定:** 「AEDは『抵抗（インピーダンス）』を測っている」

ネタ: パッドを貼った瞬間、AEDは患者の「電気の通りにくさ」を計算しています。
解説: 体が大きい人、乾燥している人、筋肉質な人で電気抵抗は違います。多くのAEDは、抵抗が高いと判断すると自動的にジュール数を上げたり、通電時間を延ばしたりして、最適な電流が心臓に届くように調整しています。「ただの電池」ではなく「頭脳」が入っているのです。

「なぜ『離れてください』と言うのか？」
ネタ: 「感電するから」は半分正解ですが、最大の理由は違います。
解説: 解析中に触れると、その振動がノイズとなり、「心室細動（VF）」と誤認してチャージしてしまうからです。逆に、CPR中に解析できる最新機種（cprINSIGHT™搭載機など）は、ノイズを除去する技術が進化したため、中断時間がゼロになりつつあります。

2. パッド・貼付位置編
「右前胸部と左側胸部の『本当の意味』」
ネタ: なぜあの位置なのか？
解説: 心臓を「電気の通り道」で挟むためです。電気は最短距離を流れます。右鎖骨下（心基部）から左脇腹（心尖部）へ流すことで、心臓の筋肉のベクトルに沿って最も効率よく電気が流れます。
裏技: 実は**「前後（胸と背中）」**で挟むのが、電気的には最も心臓に近いので効率が良いとされています（小児やペースメーカー埋め込み患者で推奨）。しかし、成人で背中に貼るには体位変換が必要でCPRが中断するため、標準は「前・横」になっています。

「ネックレスやブラジャーの金具、実は…」
ネタ: 金具の上から貼ってはいけない本当の理由。
解説: 「火傷するから」もそうですが、もっと怖いのは**「電流が金属を伝って表面を走ってしまい（ショート）、心臓の中を通らなくなること」**です。これを「分流（Shunting）」と言います。せっかくの電気が心臓を素通りしてしまうのが最大の問題です。

「貼り薬（ニトロなど）の上から貼ると爆発する？」
ネタ: 貼り薬を剥がすべき理由。
解説: ニトログリセリンのパッチなどは、通電時の熱で引火・爆発するリスクがわずかにあります。また、薬剤が絶縁体となり電気が通りにくくなります。必ず剥がして薬剤を拭き取ります。

3. 歴史・トリビア編
「AEDの日本語訳は、昔は違った」
ネタ: 今は「自動体外式除細動器」ですが。
解説: 昔は**「非医療従事者用自動除細動器」**という長い名前で呼ばれることもありました。2004年に一般市民の使用が解禁されたのが日本の救急医療の最大の転換点です。
「日本は世界一のAED大国」
ネタ: 人口あたりの設置台数は世界トップクラスです。
解説: コンビニ、駅、学校、自動販売機…。ここまで密度が高い国は稀です。しかし、**「一般市民が使用した率（使用率）」はまだ数％**に留まっています。「あるのに使われない」のが日本の課題です。

「あの独特な『音声』の秘密」
ネタ: なぜあの、ちょっと緊迫感のある（または妙に落ち着いた）声なのか。
解説: 音響心理学に基づいて設計されています。パニック状態の人間が、騒音の中でも聞き取りやすく、かつ指示に従いやすい周波数やイントネーションが研究されています。子供用モードにすると、少し優しい声になる機種もあります。

4. インストラクター向け「ここだけの話」
「ペースメーカーが入っている人の波形」
ネタ: ペースメーカーのスパイク（刺激）をAEDはどう判断する？
解説: 昔のAEDはペーシングのスパイクを「QRS波」と誤認して「ショック不要」と判断してしまうことがありました。今のAEDは高性能なフィルターでスパイクを除去し、その裏にあるVF/VTを検知できます。だから**「ペースメーカーが入っていても、迷わず貼って解析」**が正解です。

「オートショックAED（ボタンがないAED）の登場」
ネタ: 最近増えている、ボタンがない機種。
解説: 解析してショックが必要なら、カウントダウンの後に勝手に電気が流れます。救助者が「ボタンを押す恐怖」で躊躇するタイムロスをなくすためですが、インストラクターとしては「離れて！」の指示をより徹底させる必要があります。

講義での締めくくりに
「AEDはただの電気ショックの機械ではありません。 『心臓の状態を診断する優秀な心臓外科医』と『最適な電気を流すエンジニア』が、この小さな箱の中に詰まっています。

だから、私たちは安心して、その箱の指示に従うだけでいいんです」
            * **離れる理由:** 感電防止に加え、振動によるノイズ（VF誤認）を防ぐため。
            * **右前・左側:** 心臓を電流のベクトルで挟むため。「前後」も有効。
            * **ペースメーカー:** 現代のAEDはフィルタが優秀なので、スパイクがあってもVFを検知できる。迷わず貼る。
            """
        },
        {
            "title": "2重連続除細動 (DSD)",
            "text": """
            **【Double Sequential Defibrillation】**
            * 難治性VFに対し、2台の除細動器で「前側」「前後」にパッドを貼り、連続ショックを行う手法。
            """
        }
    ],
    "🫁 呼吸": [
        {
            "title": "500-600ml指導と5-6ml/kg",
            "text": """
            **【指導】**
            * 生理学的理想(6-8ml/kg)に対し、BVMは容量が大きいため、「半分」では多すぎる。
            * 「指先でクシュッと」「1/3握る」程度で十分。
            """
        },
        {
            "title": "換気回数とCCF",
            "text": """
            **【回数】**
            * 成人挿管後: 10回/分（6秒に1回）。
            
            **【CCFとの関係】**
            * 30:2の同期換気で4秒以上かけるとCCFが低下する。「1秒入れ、1秒出す」×2回＝4秒以内厳守。
            """
        },
        {
            "title": "過換気の害",
            "text": """
            **【メカニズム】**
            * 胸腔内圧上昇 → 静脈還流阻害。
            * 低CO2 → 脳血管収縮。
            """
        }
    ],
    "🧪 挿管/気道": [
        {
            "title": "挿管後の確認・管理",
            "text": """
            **【確認】**
            * 聴診（5点）よりも**波形カプノグラフィ**がGold Standard。
            * エコーも有効。
            * 比色式CO2検知器（イージーキャップ®など）
            *「Purple（紫）は、Problem（問題あり）。」 「Yellow（黄）は、Yes（OK）。」
            
            **【設定】**
            * トリガーはOFF（圧迫を自発呼吸と誤認させないため）。
            """
        },
        {
            "title": "ルーカス中の換気・BVMのコツ",
            "text": """
            **【コツ】**
            * ルーカスは圧迫時間が長い。圧解除の一瞬を狙う。
            * 非同期換気。
            """
        },
        {
            "title": "気道異物・igel",
            "text": """
            **【異物】**
            * マギル鉗子は「見えているもの」だけ。盲目的操作は禁忌。
            
            **【igel】**
            * カフなし、操作簡単。
            * 舌の循環障害リスクのため、使用は4時間以内を目安に。
            """
        }
    ],
    "💊 薬剤": [
        {
            "title": "不整脈用薬剤の詳細",
            "text": """
            * **アミオダロン:** 初回150mg 10分静注。維持投与あり。
            * **ニフェカラント:** 0.3mg/kg 静注。
            * **リドカイン:** 1〜1.5mg/kg 静注（虚血性心疾患疑い）。
            """
        },
        {
            "title": "ドパミン vs ノルアドレナリン",
            "text": """
            **【ノルアド優位】**
            * ドパミンは不整脈誘発リスクが高い。
            * 心原性ショック等では、ノルアドレナリンの方が死亡率が低い（または同等）ため第一選択。
            """
        }
    ],
    "💧 輸液": [
        {
            "title": "輸液・ルート確保",
            "text": """
            **【ルート確保】**
            * 心停止時は**上肢（肘正中など）**が推奨。
            * 骨髄路（IO）も早期に検討。
            * 輸液剤は細胞外液（リンゲル液、生理食塩水）。
            """
        }
    ],
    "🤝 チーム": [
        {
            "title": "フォロワーシップの3要素",
            "text": """
            1.  **Shared Mental Model:** 状況の共有。
            2.  **Speak Up:** 懸念の表明。
            3.  **Constructive Intervention:** 建設的介入。
            """
        },
        {
            "title": "過剰な配慮とハイジャック",
            "text": """
            **【過剰な配慮】**
            * 忖度は医療安全の敵。「命を守る指摘は失礼ではない」と教える。
            
            **【ハイジャック】**
            * メンバーが勝手に指示を出すのはNG。
            * リーダーが機能不全なら「交代します」と宣言して引き継ぐ。
            """
        }
    ],
    "🏥 蘇生後": [
        {
            "title": "TTM・シバリング・てんかん",
            "text": """
            **【TTM】**
            * 33-36℃、または「発熱回避（37.5℃以下）」。
            
            **【シバリング】**
            * 35-36℃で好発。皮膚加温、鎮静剤、筋弛緩剤で対応。
            
            **【てんかん】**
            * 蘇生後脳症に合併しやすい。予防投与も考慮。ミオクローヌスとの鑑別。
            """
        },
        {
            "title": "血糖管理",
            "text": """
            **【血糖】**
            * 
            """
        },
        {
            "title": "CO2管理・4H4T",
            "text": """
            **【CO2管理】**
            * PaCO2 35-45mmHg（正常値）を目指す。低CO2は脳虚血のリスク。
            
            **【4H4T】**
            * PEA/Asystoleの原因検索。
            * Hypoxia, Hypovolemia, Hyper/Hypokalemia, Hypothermia
            * Tension pneumothorax, Tamponade, Toxins, Thrombosis
            """
        },
        {
            "title": "冠動脈疾患疑い対応",
            "text": """
            * 12誘導ST上昇確認。
            * 左上肢ルート確保（右はカテ用）。
            * 抗血小板薬、ヘパリン準備。
            """
        }
    ],
    "🎓 教育": [
        {
            "title": "BLS相互評価・シークレットインストラクション",
            "text": """
            **【相互評価】**
            * 受講生同士で「深さは？」「戻りは？」と指摘し合わせる。
            
            **【シークレットインストラクション】**
            * 特定の受講生に「わざと過換気して」「小声で話して」と指示し、リーダーが気づけるか試す手法。
            """
        }
    ],
    "👶 小児": [
        {
            "title": "小児蘇生のポイント",
            "text": """
            **【ポイント】**
            * **呼吸原性:** 原因の9割は酸欠。
            * **15:2:** 医療者2人なら換気重視の比率。
            * **気道:** スニッフィングポジション（肩枕）。
            """
        },
        {
            "title": "小児の換気回数、成人との大きな違い",
            "text": """
            **【違い】**
            * 成人: 10回/分（6秒に1回）。
            * 小児（高度気道確保後）: **20〜30回/分（2〜3秒に1回）**。
            * 理由: 代謝が高く、アシドーシス補正が必要なため。
            """
        },
        {
            "title": "小児でHR<60は脈を触知しても胸骨圧迫を考慮！",
            "text": """
            **【判断基準】**
            * 脈拍60未満 かつ
            * 循環不全のサイン（顔色不良、意識なし、反応なし）がある場合。
            * 迷わず胸骨圧迫を開始する。「徐脈は瀕死」。
            """
        }
    ],
    "🤰 妊産婦": [
        {
            "title": "妊産婦蘇生のポイント",
            "text": """
            **【ポイント】**
            * **用手子宮左方圧排:** 仰臥位低血圧を防ぐため、子宮を左へ押す（体は傾けない）。
            * **PMCD:** 死戦期帝王切開。「4分で開始、5分で娩出」。母体蘇生のための手技。
            * **気道:** 浮腫みやすいのでチューブサイズを小さくする。
            """
        }
    ],
    "🫀 移植": [
        {
            "title": "臓器提供の要点",
            "text": """
            **【対応】**
            * 脳死・心停止後臓器提供の可能性があればNWへ連絡。
            * 家族説明の前にコーディネーターへ相談（虐待除外など）。
            
            **【種類】**
            * 脳死下（心・肺・肝・腎など）、心停止後（腎・眼球）。
            """
        }
    ],
    "📘 GL": [
        {
            "title": "JRC2025・地域GL",
            "text": """
            **【JRC2025予想】**
            * 換気回数増加？（成人10回→?）
            * DSDの推奨度。
            * 回復体位の脊椎固定解除。
            
            **【議論】**
            * 回数を増やすなら一回換気量は減らすべき（肺保護）。
            """
        }
    ],
    "❓ その他": [
        {
            "title": "準備中",
            "text": """
            (内容拡充中...)
            """
        }
    ]
}

# ==============================================================================
# 2. アプリケーション設定・UI構築
# ==============================================================================
def main():
    st.set_page_config(
        page_title="ICLS Guide",
        page_icon="🚑",
        layout="wide"
    )

    # CSS: タブの文字サイズ調整と余白削減
    st.markdown("""
        <style>
            .block-container {
                padding-top: 1rem;
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
            /* タブの見た目を調整 */
            .stTabs [data-baseweb="tab"] {
                padding-left: 10px;
                padding-right: 10px;
                padding-top: 5px;
                padding-bottom: 5px;
                font-size: 13px; /* スマホで見やすいサイズ */
            }
            /* タブリスト（スクロール領域）の調整 */
            .stTabs [data-baseweb="tab-list"] {
                gap: 5px;
            }
        </style>
    """, unsafe_allow_html=True)

    st.title("🚑 ICLS Instructor Guide")

    # ---------------------------------------------------------
    # 横スクロール式のタブ（st.tabs）を作成
    # ---------------------------------------------------------
    # 辞書順＝表示順なので、作成したリストの順番通りにタブが並びます
    tab_titles = list(ICLS_DATA.keys())
    tabs = st.tabs(tab_titles)

    # 各タブの中にコンテンツを描画
    for i, title in enumerate(tab_titles):
        with tabs[i]:
            items = ICLS_DATA[title]
            for item in items:
                with st.expander(f"📌 {item['title']}", expanded=False):
                    st.markdown(item['text'])

if __name__ == "__main__":
    main()
